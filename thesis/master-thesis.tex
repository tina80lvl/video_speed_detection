\documentclass[specification,annotation,times]{itmo-student-thesis}

%% Опции пакета:
%% - specification - если есть, генерируется задание, иначе не генерируется
%% - annotation - если есть, генерируется аннотация, иначе не генерируется
%% - times - делает все шрифтом Times New Roman, собирается с помощью xelatex
%% - languages={...} - устанавливает перечень используемых языков. По умолчанию это {english,russian}.
%%                     Последний из языков определяет текст основного документа.

%% Делает запятую в формулах более интеллектуальной, например:
%% $1,5x$ будет читаться как полтора икса, а не один запятая пять иксов.
%% Однако если написать $1, 5x$, то все будет как прежде.
\usepackage{icomma}
\usepackage{unicode-math}
%% Один из пакетов, позволяющий делать таблицы на всю ширину текста.
\usepackage{tabularx}

%% Данные пакеты необязательны к использованию в бакалаврских/магистерских
%% Они нужны для иллюстративных целей
%% Начало
\usepackage{tikz}
\usetikzlibrary{arrows}
\usepackage{filecontents}

%% Указываем файл с библиографией.
\addbibresource{master-thesis.bib}

\begin{document}

\studygroup{M42381c}
\title{Определение скорости транспортного средства безрадарным методом}
\author{Смирнова Валентина Сергеевна}{Смирнова В.С.}
\supervisor{Фильченков Андрей Александрович}{Фильченков А.А.}{к.ф.-м.н}{доцент факультета информационных технологий и программирования, Университет ИТМО}
\publishyear{2022}

%% TODO
%% Дата выдачи задания. Можно не указывать, тогда надо будет заполнить от руки.
\startdate{01}{сентября}{2020}
%% Срок сдачи студентом работы. Можно не указывать, тогда надо будет заполнить от руки.
\finishdate{27}{мая}{2022}
%% Дата защиты. Можно не указывать, тогда надо будет заполнить от руки.
\defencedate{6}{июня}{2022}

%% TODO
\addconsultant{Сивков А.А.}{магистр техники и технологии, начальник отдела новых разработок ООО "СИМИКОН"}
\addconsultant{Сивков А.А.}{магистр техники и технологии, начальник отдела новых разработок ООО "СИМИКОН"}

\secretary{Павлова О.Н.}

%% Задание
%%% Техническое задание и исходные данные к работе
\technicalspec{Требуется разработать и внедрить алгоритм определения скорости движущегося по дорогам общего пользования транспортного средства безрадарным методом, то есть по видео с камеры фиксации нарушений правил дорожного движения. Алгоритм должен определять скорость с точностью до 2 км/ч или до 3\% при скоростях свыше 100 км/ч.}

%%% Содержание выпускной квалификационной работы (перечень подлежащих разработке вопросов)
\plannedcontents{Выпускная квалификационная работа должна показывать результат, соответствующий заявленной точности определения скорости транспортного средства. }

%%% Исходные материалы и пособия
\plannedsources{\begin{enumerate}
    \item ГОСТ Р 50577-2018 <<Знаки Государственные Регистрационные Транспортных Средств>>;
    \item Jozef Gerát. Vehicle Speed Detection from Camera Stream Using Image Processing Methods;
    \item Joko Siswantoro. Real World Coordinate from Image Coordinate Using Single Calibrated Camera Based on Analytic Geometry

\end{enumerate}}

%%% Цель исследования
\researchaim{Разработать и внедрить алгоритм определения скорости транспортного средства по видеопотоку с камеры фиксации нарушении правил дорожного движения.}

%%% Задачи, решаемые в ВКР
\researchtargets{\begin{enumerate}
    \item реализация rc-парсера (выходного формата прибора);
    \item генерация синтетического датасета;
    \item разработка алгоритма определения скорости;
    \item внедрение алгоритма в тестовый прибор;
\end{enumerate}}

%%% Использование современных пакетов компьютерных программ и технологий
\addadvancedsoftware{\begin{enumerate}
	\item Пакеты \texttt{numpy}, \texttt{pandas}  и \texttt{json} языка Python3 для разработки.
	\item Программа \texttt{Blender} для работы с 3D сценами.
	\item Пакет \texttt{bpy} языка Python3 для генерации датасета через \texttt{Blender}.
	\item Программа \texttt{RecordsView} для работы с rc-файлами.
	\item Cтандартная библиотека шаблонов С++ STL.
\end{enumerate}}

%%% Краткая характеристика полученных результатов
\researchsummary{Разработан и внедрён действенный алгоритм определения скорости транспортного средства безрадарным методом.}

%%% Гранты, полученные при выполнении работы
\researchfunding{По теме данной работы гранты отсутствуют.}

%%% Наличие публикаций и выступлений на конференциях по теме выпускной работы
\researchpublications{По теме данной работы публикации отсутствуют.}

%% Эта команда генерирует титульный лист и аннотацию.
\maketitle{Магистр}

%% Оглавление
\tableofcontents

%% Макрос для введения. Совместим со старым стилевиком.
\startprefacepage

На сегодняшний день фиксация нарушений правил дорожного движения почти полностью автоматизирована и осуществляется посредствам специальных приборов, в их числе приборы производства компании <<Симикон>>:
{\begin{itemize}
	\item Комплекс <<КОРДОН-КРОСС>>
	\item Комплекс <<КОРДОН.ПРО>>М
	\item Комплекс <<КОРДОН.ПРО>>В
	\item Комплекс <<ПАРКОН-А>>
	\item Комплекс <<КОРДОН-М>>
	\item Система контроля <<ЗПИ>>
	\item Приспособление <<МИРАЖ>>
	\item Комплекс <<КОРДОН-ТЕМП>>
	\item Комплекс <<КОРДОН-М"КР>>
	\item Видеорегистратор <<ГРОМ-1>>
	\item Имитатор <<ИС-24/3>>
	\item Имитатор <<ИС-24>>Д
\end{itemize}}

\begin{figure}[!ht]
	\caption{Комплекс <<КОРДОН.Про>>М в стационарном режиме --- на столбе.}\label{img:cordon-state}
	\includegraphics[width=0.85\linewidth]{../png/cordon_pro_staition.jpg}
	\centering
\end{figure}

Для фиксации нарушений скоростного режима приборы в обязательном порядке оборудованы радаром и камерой. Радар служит для измерения скорости транспортного средства с точностью до 1 км/ч, а камера --- для распознавания Государственного регистрационного знака (далее --- номер или номерной знак) и предоставления доказательства нарушения. Полученная с камеры и радара информация обрабатывается на приборе и формируется коллаж с информацией о проезде. После чего прибор, в соответствии с ограничениями на участке, принимает решение о том, был ли данный проезд нарушением или нет и отправляет нарушения в соответствующие органы.

\begin{figure}[!ht]
	\caption{Комплекс <<КОРДОН.Про>>М в передвижном режиме --- на триноге.}\label{img:cordon-move}
	\includegraphics[width=0.85\linewidth]{../png/cordon_pro_2.jpg}
	\centering
\end{figure}

Основные приборы, используемые для фиксации скоростных нарушений --- комплексы семейства <<КОРДОН>>, далее в работе под <<приборами>> будем подразумевать именно их. КОРДОНы оборудованы радаром, камерой, ИК-прожектором и непосредственно железом, на котором производятся вычисления и хранятся нарушения. Данные приборы могут работать в 3 режимах: стационарный (Рисунок \ref{img:cordon-state}), передвижной (Рисунок \ref{img:cordon-move}) и мобильный (Рисунок \ref{img:cordon-mobile}). В работе мы будем иметь в виду стационарный режим. Далее можно будет масштабировать предложенное решение на оставшиеся режимы. Технические характеристики прибора представлены в таблице \ref{tb1:cordon-tech}.

\begin{figure}[!ht]
	\caption{Комплекс <<КОРДОН.Про>>М в мобильном режиме --- на заднем сидении.}\label{img:cordon-mobile}
	\includegraphics[width=0.85\linewidth]{../png/cordon_pro_d_auto.jpg}
	\centering
\end{figure}

Так как использование радара в приборах --- достаточно затратно, а наличие камеры в приборе обязательно для распознавания номера, формирования коллажа и предоставления доказательства нарушения, то закономерно возникает задача определения скорости транспортного средства безрадарным методом исключительно по данным с камеры прибора, другими словами --- оценка скорости транспортного средства по видео.


\begin{table}[!ht]
	\caption{Технические характеристики комплекса <<КОРДОН.Про>>М.}\label{tb1:cordon-tech}
	\centering
	\begin{tabular}{|p{0.7\textwidth}|p{0.2\textwidth}|}\hline
		\textbf{ПАРАМЕТР} &	\textbf{ЗНАЧЕНИЕ} \\\hline\hline
		Диапазон измеряемых скоростей	& 2 - 300 км/ч\\\hline
		Пределы допускаемой абсолютной погрешности измерений скорости &	± 1,0 км/ч\\\hline
		Пределы допускаемой абсолютной погрешности синхронизации
		внутренней шкалы времени с UTC(SU)	&  ± 5 мкс\\\hline
		Потребляемая мощность (при положительных температурах) &	не более 25 Вт\\\hline
		Масса датчика & не более 6,0 кг\\\hline
		Габаритные размеры	& не более 460×180×280 мм\\\hline
	\end{tabular}
\end{table}



%% Начало содержательной части.
\chapter{Обзор возможностей комплекса <<КОРДОН.Про>>М}\label{chp1}
В данной главе мы введём ключевые понятия, подробно рассмотрим технологии, по которым на сегодняшний день работает прибор семейства <<КОРДОН>> и рассмотрим существующие решения для определения скорости объекта по видео.


\section{Определения и ключевые понятия}
Для начала введем определения, ключевые понятия и некоторые сокращения, которые будут использоваться в работе:
\begin{itemize}
	\item \textbf{транспортное средство (ТС)} --- любой участник дорожного движения, обладающий Государственным регистрационным знаком (автомобиль, мотоцикл, автобус, грузовик)
	\item \textbf{Государственный регистрационный знак (ГРЗ)} --- номерная пластина на транспортном средстве, соответствующая ГОСТу Р 50577-2018 <<Знаки Государственные Регистрационные Транспортных Средств>>
	\item \textbf{правила дорожного движения (ПДД)} --- свод правил, регулирующих обязанности участников дорожного движения (водителей транспортных средств, пассажиров, пешеходов и так далее), а также технические требования, предъявляемые к транспортным средствам, для обеспечения безопасности дорожного движения, актуальные на момент написания работы
	\item \textbf{нарушение} --- любое нарушение правил дорожного движения, однако в данной работе под <<нарушением>> будем понимать нарушение скоростного режима на рассматриваемом участке
\end{itemize}

Также необходимо определить, что выход прибора --- не просто видео-файл, а специальный формат \texttt{.rc}, который содержит в себе всю информацию с прибора, как, например, битовые представления кадров, радарные данные, проекционная матрица камеры, время, информация о распознанных номерах, данные о GPS, карты глубины, данные о настройках камеры и другое. В данной работе мы будем обрабатывать именно этот формат, поэтому, рассмотрим его подробнее.

\section{Содержание RC-файла} \label{par:rc-description}

RC-файл представляет из себя битовый файл, состоящий из frame-ов (рисунок \ref{img:rc-file}). Каждый фрейм описывает 1 кадр из записи. В начале каждого фрейма находятся 2 поля: \texttt{magic} и \texttt{length}, за ними идёт непосредственно информация о фрейме --- \texttt{frame data}. Поле \texttt{magic} служит исключительно для проверки корректности чтения, оно имеет константное значение \texttt{0x11223307} для всех фреймов. Поле \texttt{length} определяет длину \texttt{frame data}(включая \texttt{magic} и \texttt{length}), то есть сколько последующих бит будет относиться к текущему фрейму.

\begin{figure}[!ht]
	\caption{Представление RC-файла.}\label{img:rc-file}
	\includegraphics[width=0.85\linewidth]{../png/rc_file.png}
	\centering
\end{figure}

Каждый фрейм содержит в себе набор данных соответствующих типов, схема представлена на рисунке \ref{img:frame-data}. В начале каждого фрагмента данных присутствует 2 поля: \texttt{id} и \texttt{length}. Поле \texttt{id} определяет тип читаемых данных во фрагменте, это может быть примитивный тип, как, например, \texttt{timestamp} или целые структуры, как, например, \texttt{sCameraData}. Подробное описание каждого типа представлено в приложении \ref{tb1:frame-data}. Поле \texttt{length} аналогично одноимённому полю в RC описывает длину последующей последовательности.

\begin{figure}[!ht]
	\caption{Представление frame-а.}\label{img:frame-data}
	\includegraphics[width=0.85\linewidth]{../png/frame_data.png}
	\centering
\end{figure}

В таблицах \ref{tb1:rc-type} и \ref{tb1:frame-type} приложения представлено подробное описание к рисункам \ref{img:rc-file} и \ref{img:frame-data} соответственно. Теперь подробнее остановимся на 2 типах данных из таблицы \ref{tb1:frame-data} --- информации о распознанных номерах и радарных целях.

\paragraph{Результаты распознавания номера}
Результаты распознавания номера соответствуют ID=5 из таблицы \ref{tb1:frame-data} и представляют собой массив типа \texttt{TRectNumber}. Реализация структуры описана в листинге \ref{lst:trect}.

\begin{figure}[!ht]
	\caption{Координаты номера в структуре \texttt{TRectNumber}.}\label{img:licnum-recog-ind}
	\includegraphics[width=0.85\linewidth]{../png/licnum_recog_coords.png}
	\centering
\end{figure}

\begin{lstlisting}[float=!h,caption={Реализация структуры \texttt{TRectNumber}.},label={lst:trect}]
#define	MAX_SYMBOL_NUM (16)

typedef int16_t TInt3[4];

typedef struct TRectNumber
{
	int numFormat;
	int n_symbols;
	uint16_t text16[MAX_SYMBOL_NUM];

	int16_t allCert;
	int16_t certList[MAX_SYMBOL_NUM];
	TInt3 x, y;

	} TRectNumber;
}
\end{lstlisting}


Здесь \texttt{numFormat} --- тип номерной рамки, складывается из страны  и формата (однострочный/двустрочный), \texttt{n\_symbols} --- количество распознанных символов,  \texttt{text16} --- непосредственно распознанный текст в кодировке UINT-16,  \texttt{allCert} --- общая вероятность распознавания,  \texttt{certList} --- массив вероятностей распознавания каждого символа,  \texttt{x} и \texttt{y} --- массивы координат распознанного номера, порядок отображён на рисунке \ref{img:licnum-recog-ind}.


\paragraph{Цели с радара}
Результаты распознавания номера соответствуют ID=8 из таблицы \ref{tb1:frame-data} и представляют собой массив типа \texttt{umrr\_target}. Реализация структуры описана в листинге \ref{lst:umrr}.

\begin{lstlisting}[float=!h,caption={Реализация структуры \texttt{umrr\_target}.},label={lst:umrr}]
class umrr_target
{
	public:
		std::string doString() const;
		double absSpeed() const;

		int id;
		double x;
		double y;
		double xspeed;
		double yspeed;
		double len;

		// calc values
		double imgx;
		double imgy;
		int numw;

		double imgx_left;
		double imgx_right;

		double imgy_top;
		double imgy_bottom;
}__attribute__((__packed__));
\end{lstlisting}

Здесь \texttt{id} --- идентификационный номер радарной цели от 0 до 63 (количество одновременно отслеживаемых целей), \texttt{x} --- координата \texttt{x} в плоскости дороги, \texttt{y} --- координата \texttt{y} в плоскости дороги,  \texttt{xspeed} --- мгновенная скорость по оси \textit{x},  \texttt{yspeed} --- мгновенная скорость по оси \textit{y},  \texttt{len}  --- длина транспортного средства. Система радарных координат располагается в основании столба, на котором установлен прибор, и считается по правилу правой руки, визуализация представлена на рисунке \ref{img:road-coords}.

\begin{figure}[!ht]
	\caption{Расположение системы радарных координат.}\label{img:road-coords}
	\includegraphics[width=0.85\linewidth]{../png/road_coords.png}
	\centering
\end{figure}

\section{Возможности прибора} \label{sec:cordon-charact}
Для того, чтобы начать разработку нового решения, необходимо разобраться с тем, как устроен работающий прибор. Во введении мы определили основные характеристики и возможности прибора. Теперь чуть более подробно рассмотрим основные функции и алгоритм его работы, чтобы определить, какую информацию можно использовать для разработки. Ниже представлен перечень всех функций и возможностей универсального комплекса <<КОРДОН.Про>>М:

\paragraph{Автоматическая фотовидеофиксация}
\begin{itemize}
	\item Автоматическая фотовидеофиксация нарушений ПДД в зоне контроля до шести полос движения  одновременно в обоих направлениях.
	\item Измерение скоростей в диапазоне от 2 до 300 км/ч.
	\item Возможность измерения средней скорости на протяженных участках совместно с любыми другими комплексами семейства «Кордон».
	\item Возможность фиксации нарушения «Непредоставление преимущества пешеходу» при наличии дополнительного блока «Мера».
	\item Возможность дооснащения обзорной камерой для работы со знаками переменной информации.
	\item Отдельные пороги скорости для разных полос движения и для ТС категорий «В», «С» и «D».
	\item Автоматическое сохранение фотоматериалов и видеоролика по каждому зафиксированному нарушению.
	\item Модуль ГЛОНАСС/GPS с автоматической коррекцией системного времени комплекса.
\end{itemize}

\paragraph{Распознавание номерных знаков и розыск ТС}
\begin{itemize}
	\item Автоматическое распознавание номерных знаков многих стран мира, включая двустрочные номера и российские ГРЗ нового образца по ГОСТ Р 50577-2018.
	\item Возможность включения и выключения распознавания ГРЗ тех или иных государств.
	\item Проверка распознанных номеров по базам данных с оповещением оператора и голосовым озвучиванием номера.
	\item Специальный режим работы «Перехват» для розыска ТС с отсутствующими или нечитаемыми номерными знаками.
\end{itemize}

\paragraph{Классификация ТС}
\begin{itemize}
	\item  Автоматическое определение типа ТС и их классификация по четырём основным категориям (легковые, грузовые, автобусы, среднегабаритные).
	\item  Автоматическое присвоение соответствующей категории ТС порога скорости по ПДД.
	\item  Автоматический контроль запрета движения ТС для заданной категории (грузовые, автобусы и т.д.) по отдельным полосам или по дороге в целом.
\end{itemize}

\paragraph{Видеонаблюдение}
\begin{itemize}
	\item Трансляция видеопотока с высоким разрешением по протоколу RTSP.
	\item Ведение непрерывной видеозаписи с возможностью скачивания видеоролика по заданному промежутку времени.
\end{itemize}

\paragraph{Передача данных}
\begin{itemize}
	\item Передача данных на сервер ЦОД по зашифрованным проводным или беспроводным каналам связи (3G/4G).
	\item Автоматическое переключение на резервные каналы связи (Wi-Fi, 4G) при сбоях или отказе основного канала.
	\item Возможность параллельной передачи данных с комплекса на различные серверы.
\end{itemize}

\paragraph{Защита и безопасность}
\begin{itemize}
	\item Защита данных и встроенного ПО от несанкционированных изменений.
	\item Экспортируемые данные защищены ЭЦП.
	\item Ведение журнала событий и действий пользователя комплекса.
	\item Передача уведомлений по SMS и электронной почте о зафиксированных фактах физических воздействий на прибор (удары, вибрация).
	\item Возможность защиты от огнестрельного оружия с использованием бронированного кожуха, сертифицированного на пулестойкость по классам «Бр2» (пистолеты СПС и ТТ) и «С1» (охотничье ружье со свинцовой пулей).
\end{itemize}

\paragraph{Телеметрия и диагностика}
\begin{itemize}
	\item Самодиагностика, удаленная диагностика.
	\item Автоматическое отслеживание параметров комплекса и передача телеметрической информации в режиме реального времени.
\end{itemize}

\paragraph{Установка}
\begin{itemize}
	\item Автоматическая проверка правильности монтажа комплекса.
	\item Поворотный кронштейн для быстрой стационарной установки на опоре.
	\item Удобный и простой веб-интерфейс для настройки.
	\item Различные варианты подключения к сетям электропитания. Возможность подключения к осветительной сети и обеспечения бесперебойной работы комплекса от АКБ.
\end{itemize}

\paragraph{Работа в ночное время}
\begin{itemize}
	\item Встроенная инфракрасная подсветка для работы в ночное время.
	\item Дополнительный внешний ИК-прожектор для гарантированного определения марки ТС по изображению.
\end{itemize}

\paragraph{Статистика}
\begin{itemize}
	\item Сбор статистических данных об интенсивности транспортного потока.
	\item Построение интерактивных графиков по выбранным статистическим параметрам.
	\item Анализ зафиксированных нарушений ПДД с разбивкой по видам нарушений и величине превышения скорости.
\end{itemize}

\section{Входные данные для исследования}
Из секции \ref{sec:cordon-charact} и описания RC-файла в секции \ref{par:rc-description} можно вынести следующую полезную информацию, которая будет использоваться в дальнейшем в работе:
\begin{enumerate}
	\item из информации об установке прибора в стационарном режиме:
	\begin{enumerate}
		\item высоту столба --- \texttt{H}
		\item расстояние до дороги --- \texttt{R}
		\item угол между направлением движения и направлении камеры --- $ \alpha  $
	\end{enumerate}
	\item из информации о самом приборе:
	\begin{enumerate}
		\item физические размеры матрицы --- высота \texttt{h\_m} и ширина \texttt{w\_m} в миллиметрах
		\item разрешение --- высота \texttt{h\_m} и ширина \texttt{w\_m} в пикселях
		\item фокусное расстояние --- \texttt{f}
	\end{enumerate}
	\item из RC-файла:
	\begin{enumerate}
		\item проекционная матрица камеры 3x4 --- \texttt{matrix}
		\item данные по распознанным номерам --- \texttt{licnum}
		\item радарные данные --- \texttt{radar\_targets}
	\end{enumerate}
\end{enumerate}

\chapterconclusion

В первой главе мы подробно разобрали устройство и возможности прибора на примере комплекса  <<КОРДОН.Про>>М. Стоит отметить, что примерно все приборы семейства <<КОРДОН>> обладают схожими характеристиками и возможностями. Например, любой прибор можно дооборудовать цветной камерой, дополнительным прожектором, источником питания или бронированным кожухом. Принципиальное отличие <<КОРДОН.Про>>М и <<КОРДОН.Про>>В в наличии радара, в <<В>>  версии он отсутствует, что удешевляет производство, однако использовать такой прибор для фиксации скоростных нарушений пока не возожно. Данный факт непосредственно подтверждает актуальность внедрения решения данной работы.

Кроме того, в данной главе мы определили необходимые для вычислений переменные и структуры, которые будут использованы в последующих главах. Также, был подробно рассмотрен основной формат данных для исследования --- RC-файл, его содержание, подробное описание каждого типа данных и содержащихся в них структур. Стоит отметить, что данный формат будет использоваться как в качестве тренировочных данных (имеются в виду записи c различных приборов в разных городах и при разных условиях в формате \texttt{.rc}), так и для внедрения решения непосредственно в реальный прибор.

\chapter{Обзор существующих решений}\label{chp2}
На сегодняшний день существует несколько подходов к решению задачи определения скорости по видео. В основном, используются технологии компьютерного зрения и линейная алгебра. В данной главе мы рассмотрим наиболее перспективные подходы, их преимущества и недостатки и наметим план решения.
%% Так помечается начало обзора.
\startrelatedwork
\section{Базовая геометрическая оптика} \label{sec:base-optics}
Один из самых простых подходов \cite{5228496} основывается на базовой геометрической оптике \cite{Wilkinson2012}. Вспомним некоторые базовые определения:

\begin{enumerate}
	\item \textit{фокус собирающей линзы} --- это место, где все проходящие через линзу лучи света пересекаются;
	\item \textit{фокусное расстояние собирающей линзы $ f $} --- это  отрезок от принятого центра линзы до её фокуса;
	\item \textit{объектом}  называется физическое тело, участвующее в оптической системе. Обычно объект располагается перед линзой;
	\item \textit{изображением}  называется проекция объекта на экран или матрицу (располагается после линзы);
	\item \textit{расстоянием до объекта $ d $} называется отрезок между объектом и линзой;
	\item \textit{расстоянием до изображения $ f $} называется отрезок между изображением и линзой.
\end{enumerate}

\begin{figure}[!ht]
	\caption{Схема собирающей линзы.}\label{img:optic}
	\includegraphics[width=0.85\linewidth]{../png/optic.png}
	\centering
\end{figure}

Из законов базовой оптики известно, что зная физические размеры объекта и экрана (в нашем случае в качестве экрана выступает матрица камеры), также, зная фокусное расстояние линзы, можно найти расстояние до объекта \cite{algebra}. На рисунке \ref{img:optic} представлена схема собирающей линзы, а формулой \ref{eq:optics1} описывается выше упомянутое отношение в общем виде.

\begin{equation}
\mathit{\frac{Sensor\_dimension (mm)} {Focal\_length (mm)} = \frac{Field\_dimension (mm)} {Distance\_to\_Field (mm)}}
\label{eq:optics1}
\end{equation}

Если подставить вместо размера экрана ($Field\_dimension$) размер объекта, то можно получить выражения \ref{eq:optics2} и \ref{eq:optics3}:

\begin{equation}
\mathit{Object\_height\_on\_sensor (mm) = \frac{Sensor\_height (mm)  \cdot  Object\_height (pixels)} {Sensor\_height (pixels)}}
\label{eq:optics2}
\end{equation}

\begin{equation}
\mathit{Object\_height\_on\_sensor (mm) = \frac{Real\_Object\_height (mm) \cdot  Focal\_length (mm)} {Distance\_to\_object (mm)}}
\label{eq:optics3}
\end{equation}

Путём простейшей подстановки из данных формул можно вывести формулу нахождения расстояния от камеры до объекта \ref{eq:optics_final}.


\begin{equation}
\mathit{Distance\_to\_object (mm) = \frac{Real\_Object\_height (mm) \cdot  Focal\_length (mm) \cdot Sensor\_height (pixels)} {Sensor\_height (mm)  \cdot  Object\_height (pixels)}}
\label{eq:optics_final}
\end{equation}

В статье \cite{5228496}  описано решение, основанное именно на этом подходе и погрешность составляет 4\%. Если переводить это на километры, то погрешность составит от 1 до 12 км/ч при заявленном диапазоне скоростей от 0 до 300 км/ч, что больше допустимой погрешности, поэтому данное решение недостаточно точное для данного исследования.

\section{Компьютерное зрение}
Остальные перспективные решения \cite{Gawande20} основываются на работе с изображениями, а именно разбиением транспортного средства на составляющие и привязкой к одной из них.

\begin{figure}[!ht]
	\caption{Вырезка из источника \cite{8124468}, детект сбоку.}\label{img:side_car}
	\includegraphics[width=0.85\linewidth]{../png/side_car.png}
	\centering
\end{figure}

Например, в источнике \cite{8124468} скорость автомобиля определяется сбоку (рисунок), то есть применены допущения, что камера установлена перпендикулярно дороге, что в реальном мире невозможно, поэтому данное решение также нам не подходит.

\begin{figure}[!ht]
	\caption{Вырезка из источника \cite{6754885}, детект спереди под углом.}\label{img:corner1}
	\includegraphics[width=0.85\linewidth]{../png/corner1.png}
	\centering
\end{figure}

\begin{figure}[!ht]
	\caption{Вырезка из источника \cite{6754885}, разбиение автомобиля на точки.}\label{img:corner2}
	\includegraphics[width=0.85\linewidth]{../png/corner2.png}
	\centering
\end{figure}

В другом источнике \cite{6754885} машина разбивается на точки кривых и детект \cite{surveillance} ведётся по крайней из этих точек. Очевидно, что из-за сложной формы автомобиля, цвета и бликов, крайние точки могут меняться, что вызовет большую погрешность. Не смотря на подходящий для нашей работы ракурс и заявленную точность определения скорости до 2 км/ч, на это число нельзя ориентироваться, так как исследование \cite{6754885} проводилось всего на нескольких видео и данных недостаточно для сбора подобной статистики. Также  в этой статье были приняты некоторые допущения при вычислениях, как например замена поправочного коэффициента камеры на константу, зависимую от координат пикселя, что также недопустимо.


\begin{figure}[!ht]
	\caption{Вырезка из источника \cite{09903}, пример синтетических данных.}\label{img:syntet}
	\includegraphics[width=0.85\linewidth]{../png/syntet.png}
	\centering
\end{figure}

Ещё один популярный подход \cite{09903} основан на расположении камеры непосредственно над дорогой. Из данного положения, приняты некоторые допущения, исходя из которые детекция транспортного средства может проводится исключительно по прямой траектории по одной полосе движения. Во-первых, расположение камеры над дорогой не является универсальным решением, так как далеко не на всех участках дороги это возможно. Во-вторых, мы хотим детектить до 30 целей одновременно, а на одной полосе это невозможно. Однако так как данное решение основано да синтетических данных (рисунок ), то есть видеопоток является вручную сгенерированной 3D сценой, возьмём эту технику на заметку.


%% Так помечается конец обзора.
\finishrelatedwork

\chapterconclusion

В данной главе мы рассмотрели существующие подходы к решению задачи нахождения скорости по видео. Максимально достигнутая точность определения скорости --- 2 км/ч, однако нельзя полагаться на данный результат, так как в статье \cite{6754885} присутствуют некоторые неточности и не произведено достаточное количество экспериментов для получения статистически значимого результата.

Наиболее правдоподобный подход обеспечивает погрешность до 7 км/ч, однако он основывается на расположении камеры непосредственно над движущемся транспортным средством, что не позволит измерять скорость на многополосной дороге (как заявлено в характеристиках нашего прибора) и при перестроениях, а только на одной полосе.

Кроме того, в нескольких из рассмотренных подходов используются синтетические данные, что готовит о том, что подобный подход к формированию датасета имеет место быть.

\chapter{Предложенное решение}
В данной главе мы разобьём задачу определения скорости по видео на более мелкие подзадачи и  приведём решение каждой из них.

\section{Сбор входных данных. RC-парсер} \label{sec:data}
В главе \ref{chp1} мы вывели некоторый список входных данных, связанных с характеристиками прибора, которые необходимо определить отдельно для каждого RC-файла, например, фокусное расстояние, размеры матрицы камеры, высота установки прибора. Для этого соберём некоторый набор реальных данных, записанных на приборах при различных условиях. Для этого воспользуемся базой заранее записанных файлов, рисунок \ref{img:web-rc}.

\begin{figure}[!ht]
	\caption{WEB-интерфейс базы с RC-файлами.}\label{img:web-rc}
	\includegraphics[width=0.85\linewidth]{../png/web_rc.png}
	\centering
\end{figure}

Так как работать с  RC-файлами достаточно неудобно, возникла задача извлечения релевантных для исследования данных и преобразования их в удобный формат. Для этого, на языке Python был реализован парсер RC-формата в привычный JSON (пример представлен на листинге \ref{lst:json}). Подробнее остановимся на его содержании.

\begin{lstlisting}[float=!h,caption={Пример JSON-файла.},label={lst:json}]
{
	"frames": [
		{
		"seconds": 1596722143,
		"microseconds": 379221,
		"licnums": [
			{
				"format": 42139649,
				"text": "м684тв186",
				"x": [450,399,400,449],
				"y": [39,30,42,27]
			}
		],
		"radar_targets": [
			{
				"id": 40,
				"x": 60.608,
				"y": 4.5439,
				"xspeed": -21.4,
				"yspeed": -0.3,
				"carlen": 4.0
			},
	]
	"matrix_type": 0.0055,
	"focal_length": 35.0,
	"matrix3x4": [ 865.751108, -6388.572118, -544.713764, -301.569121, -841.281125,	344.588298, -6313.435574, 54640.980513,	0.978972, -0.032996, -0.20131, -1.268419 ]
}
\end{lstlisting}

Поля \texttt{seconds} и \texttt{microseconds} описывают время в тиках прибора с начала UNIXTime. Поле \texttt{licnums} представляет собой массив с информацией о распознанных номерах. Поле \texttt{radar\_targets} описывает радарные цели. Важно отметить, что в текущем состоянии не известно, какая радарная цель какому распознанному номеру соответствует, эта проблема будет подобна разобрана в секции \ref{sec:radar}. Поля \texttt{matrix\_type} и \texttt{focal\_length} описывают тип матрицы камеры и её фокусное расстояние соответственно. Из типа матрицы можно получить её физические размеры: ширину, высоту в пикселях и миллиметрах и разрешение. И, наконец, поле \texttt{matrix3x4} хранит в себе проекционную матрицу камеры 3x4, она понадобится нам в дальнейшем для восстановления координат.

\section{Объект мониторинга} \label{sec:monitor}
В главе \ref{chp2} мы определили, что разбиение автомобиля на части в конечном итоге является неточным способом для определения скорости, так как могут появляться блики, части автомобиля могут быть закрыты, деформированы, сливаться с окружающей средой. Поэтому возникает вопрос: к какой точке автомобиля необходимо привязываться, чтобы следить за её перемещением с максимальной точностью. В качестве такой точки был выбран номерной знак. Основные преимущества данного выбора заключаются в следующем:

\begin{enumerate}
	\item для любого кадра, где распознан номер, известны координаты 4 углов этого номера с точностью до нескольких сантиметров, а в случаях, когда номер не распознан, формирование нарушения невозможно;
	\item для каждого номера известен его точный физический размер согласно ГОСТу (рисунок \ref{img:licnum-gost}).
\end{enumerate}


\begin{figure}[!ht]
	\caption{Габариты Государственного регистрационного знака согласно актуальному на момент написания работы ГОСТу.}\label{img:licnum-gost}
	\includegraphics[width=0.85\linewidth]{../png/licnum1.jpeg}
	\centering
\end{figure}

\subsubsection{Сбор датасета Государственных регистрационных знаков}
Так как в работе мы будем использовать габаритные размеры номерной пластины, а их существует большое множество (рисунок \ref{img:plates}), был собран датасет, который для каждого типа номерной пластины описывает её габаритные размеры согласно ГОСТу.

\begin{figure}[!ht]
	\caption{Типы Государственных регистрационных знаков.}\label{img:plates}
	\includegraphics[width=0.85\linewidth]{../png/plates.png}
	\centering
\end{figure}

\section{Алгоритм определения скорости}
%% TODO cite
Для начала дадим определение скорости. \textit{Скорость} ---  векторная физическая величина, характеризующая быстроту перемещения и направление движения материальной точки относительно выбранной системы отсчёта. По определению, равна производной радиус-вектора точки по времени. В СИ измеряется в метрах в секунду.
\begin{equation}
\mathit{\vec{v}=\frac{\vec{dr}} {dt}}
\label{eq:v}
\end{equation}

Так как точное время для каждого фрейма известно, остаётся найти перемещение объекта, чью скорость мы собираемся измерить и так как в секции \ref{sec:monitor} было принято решение наблюдать за номером, задача сводится к нахождению перемещения номерного знака между кадрами.

Согласно законодательству, для формирования штрафа, необходимо предоставить доказательную базу в виде коллажа с изображением транспортного средства и номерного знака с измеренной на момент кадра \textit{моментальной} скоростью. Данное ограничение приводит нас к выводу, что перемещение необходимо измерять между 2 ближайшими фреймами. Теперь перейдём непосредственно к решению.

Рассмотрим положение номера в двух моментах времени --- $ t_1 $ и $ t_2 $. Схема представлена на рисунке \ref{img:r-scheme}.

\begin{figure}[!ht]
	\caption{Схема перемещения номерного знака.}\label{img:r-scheme}
	\includegraphics[width=0.85\linewidth]{../png/r_scheme.png}
	\centering
\end{figure}

Из оптических отношений, рассмотренных в части \ref{sec:base-optics}, зная физические размеры матрицы камеры, фактический размер объекта и фокусное расстояние, можно определить расстояние до объекта, то есть длины красных векторов на рисунке \ref{img:r-scheme}.

Из векторной геометрии очевидно, что чтобы найти перемещение $r$ достаточно найти разность векторов $a$ и $b$, однако для нахождения разности векторов, необходимо дополнительно знать либо угол между ними, либо координаты обоих векторов, а ни того, ни другого у нас нет, поэтому возникает промежуточная задача нахождения координат этих векторов в пространстве.

Так как мы рассчитали расстояние до центра номера, чтобы восстановить координаты проведённого вектора достаточно будет найти координаты номерной платины в пространстве. Для этого решим задачу триангуляции.

\paragraph{Приведение задачи триангуляции}
Классическая задача триангуляции \cite{845377} восстанавливает 3D координаты \cite{inproceedings} объекта по изображения с 2 камер. В общем случае уравнение триангуляции \ref{eq:triang-base} представляет собой простое отношение, где $ x $ --- координаты объекта на изображении, $ P $ --- проекционная матрица камеры 3x4, $ X $ --- координаты объекта в пространстве.

\begin{equation}
\mathit{ x=PX }
\label{eq:triang-base}
\end{equation}

Так как векторы $ x $ и $ PX $ имеют одно и то же направления, их векторное произведение будет равняться нулю (уравнение \ref{eq:triang-cross}).

\begin{equation}
\mathit{ x \times PX=0 }
\label{eq:triang-cross}
\end{equation}

Раскрывая предыдущие уравнения, получаем следующее \ref{eq:full-triang}:

\begin{equation}
\mathit{
    \begin{bmatrix}
       x \\
       y \\
       z
     \end{bmatrix} =
     \begin{bmatrix}
         p_1 & p_2 & p_3 & p_4 \\
         p_5 & p_6 & p_7 & p_8 \\
         p_9 & p_{10} & p_{11} & p_{12}
     \end{bmatrix}
     \begin{bmatrix}
         X \\
         Y \\
         Z \\
         1
     \end{bmatrix}
}
\label{eq:full-triang}
\end{equation}

Путём некоторых преобразований получаем уравнения \ref{eq:final2} для двух камер.

\begin{equation}
\mathit{
    \begin{bmatrix}
       y p_3^T - p_2^T \\
       p_1^T - x p_3^T \\
     \end{bmatrix} X =
     \begin{bmatrix}
         0 \\
         0
     \end{bmatrix} ,
     \begin{bmatrix}
       y' p_3^{'T} - p_2^{'T} \\
       p_1^{'T} - x' p_3^{'T} \\
     \end{bmatrix} X =
     \begin{bmatrix}
         0 \\
         0
     \end{bmatrix}
}
\label{eq:final2}
\end{equation}


Однако в нашем случае всего лишь одна камера и решить второе уравнение представляется невозможным. Зато мы знаем целых 4 координаты номерной пластины и её точные физические размеры согласно ГОСТу. Эта информация позволяет компенсировать отсутствие второй камеры путём вывода одних координат через другие посредствам формулы для Декартова расстояния \ref{eq:decart}.

\begin{equation}
\mathit{ d=\sqrt{ 	(x_{2}-x_{1})^{2}   +   (y_{2}-y_{1})^{2}   +   (z_{2}-z_{1})^{2} }  }
\label{eq:decart}
\end{equation}

Введём некоторое допущение, что номер движется по направлению движения, это позволит сократить координаты $ y $ и $ z $ в уравнении \ref{eq:decart}, что тем самым позволит выразить координаты одной точки номера через другую. Тогда система наших уравнений превращается в однородную.

\begin{equation}
\mathit{
    \begin{bmatrix}
       y p_3^T - p_2^T \\
       p_1^T - x p_3^T \\
       (d - y) p_3^T - p_2^T \\
       p_1^T - (d - x) p_3^T \\
     \end{bmatrix} X =
     \begin{bmatrix}
         0 \\
         0 \\
         0 \\
         0
     \end{bmatrix}
}
\label{eq:system}
\end{equation}

Путём решения системы уравнений посредствам сингулярного разложения (SVD), восстановим координаты номера в пространстве. Теперь для левой верхней точки номера мы знаем её координаты в пространстве и можем за ней следить. Остаётся только посчитать координаты для каждого фрейма и определить перемещение путём вычисления декартового расстояния в трёхмерном пространстве.


%% \section{Тонкости реализации}


\section{Генерация синтетических данных}
Для качественной оценки работы алгоритма оценки скорости по видео, необходимо иметь достаточно большой набор данных. Кроме этого, распределение скоростей в этих данных должно располагаться в заявленном диапазоне, для наших приборов этот диапазон составляет промежуток от 0 до 300 км/ч. Так как все реальные данные собраны с тестовых приборов в черте города, где транспортные средства в большинстве своём движутся со скоростями 40-80 км/ч, то среди реальных данных почти невозможно найти примеры с очень большими (более 100 км/ч) или очень маленькими (менее 20 км/ч) скоростями. Поэтому возникает задача генерации синтетических данных с недостающими примерами для полноценной оценки работы алгоритма.

\subsection{Объект разработки}
Прежде, чем приступать к процессу разработки, необходимо определить объект этой разработки. Цель данной секции – разработать программу (или связку программ/сервисов), на выходе которой мы получим RC-файл, идентичный по характеристикам с реальными записями. Теперь перейдём непосредственно к процессу разработки.

Основная часть RC-файла --- битовые представления изображений с камеры прибора, из которых строится видео, другими словами, видео --- это последовательный набор изображений. Изображение, в свою очередь, является проекцией объектов пространства на матрицу камеры. Это значит, что для создания идентичного реальному RC-файлу набора данных, необходимо воссоздать 3D-сцену и её проекцию на виртуальную камеру.

После тщательного исследования существующих инструментов и форматов для работы с 3D-сценами, было принято решение воспользоваться программой Blender для создания 3D-сцен и форматом gltf для их последующей обработки. На рисунке \ref{img:blender} представлен пример созданной 3D-сцены в среде разработки Blender. Теперь подробнее остановимся на формате gltf.

\begin{figure}[!ht]
	\caption{Пример созданной 3D-сцены в среде разработки Blender.}\label{img:blender}
	\includegraphics[width=0.85\linewidth]{../png/blender.png}
	\centering
\end{figure}

\subsection{GLTF-формат}
Формат gltf представляет собой текстовый файл, напоминающий json, только хранит в себе не примитивные типы, а полную информацию о 3D-сцене, такую как формы объектов, их координаты, информация о материалах, текстурные карты, описание анимации, информация о камере (её положение, настройки) и другое. В нашем случае, основными преимуществами данного формата являются простая читаемость, полнота информации, возможность задания любых параметров. А преимуществом работы в программе Blender является то, что можно легко экспортировать созданную сцену в необходимый gltf формат.

Таким образом мы можем получить готовый gltf-файл c необходимыми нам параметрами, как, например, скорость и госномер. Однако, создавать новую 3D-сцену для каждого набора параметров – весьма ёмкая задача, поэтом возникает вопрос автоматизации данного процесса. Посредствам модуля bpy для языка Python, можно работать с теми же 3D-сценам, задавая или изменяя параметры, тем самым автоматизируя процесс генерации данных. На листинге \ref{lst:bpy} представлен пример кода, подставляющий госномер в виде текстуры из файла. Аналогичный код был написан для подстановки типа и скорости анимации, далее эти отрывки были помещены в цикл и сгенерированы необходимые gltf-файлы.


\begin{lstlisting}[float=!h,caption={Пример скрипта для подстановки ГРЗ из файла на объект в 3D-сцене.},label={lst:bpy}]
import bpy
from bpy import context, data, ops

mat = bpy.data.materials.new(name="New_Mat")
mat.use_nodes = True
bsdf = mat.node_tree.nodes["Principled BSDF"]
texImage = mat.node_tree.nodes.new('ShaderNodeTexImage')
texImage.image = bpy.data.images.load("/Users/tina/dev/simicon/plates/Y999YY25.jpg")
mat.node_tree.links.new(bsdf.inputs['Base Color'], texImage.outputs['Color'])

ob = context.view_layer.objects.active

# Assign it to object
if ob.data.materials:
	ob.data.materials[0] = mat
else:
	ob.data.materials.append(mat)
\end{lstlisting}

\subsection{Gplay}
Итак, мы получили набор gltf-файлов со всеми интересующими нас параметрами, закономерно возникает вопрос: как преобразовать этот формат в необходимый нам полноценный RC. Для этой задачи был разработан сервис gplay, который берёт на вход gltf-файл и по описанной в нём анимации и информации и сцене генерирует RC-файл исключительно с информацией о картинках, то есть видео. Между тем, некоторые из необходимых нам типов данных никак не описаны в gltf-файле, а, соответственно, и в выходном RC. Речь идёт про радарные данные и информацию о распознавании номеров. Решается данная проблема достаточно просто: для восстановления радарных данных можем воспользоваться известными нам координатами объектов в 3D-сцене (известны из gltf-файла) путём простого пересчёта координат в расстояние до камеры; для заполнения информации о распознанных номерах просто пропустим запись через эмулятор с сервисом распознавания номеров, который дополнит наш RC-файл. На рисунке \ref{img:rv} можно увидеть итоговый RC-файл с заполненными радарными данными и распознанными номерами.

\begin{figure}[!ht]
	\caption{Итоговый RC-файл в программе \texttt{RecordView}.}\label{img:rv}
	\includegraphics[width=0.85\linewidth]{../png/recordsview.png}
	\centering
\end{figure}

\texttt{RecordsView} --- внутренний инструмент компании «Симикон» для просмотра RC-записей. Справа на изображении находится видео, слева -- радарные данные, снизу --- распознанные номера и возможность задать параметры камеры и рассчитать матрицу 3х4.

Таким образом, из связки программ, представленных на схеме \ref{img:progs}, где в Blender мы создаём основу для 3D-сцены и скриптами генерируем gltf-файлы, далее пропускаем через сервис \texttt{gplay}, который конвертирует gltf в rc, далее пропускаем через сервис \texttt{hwrecog} для распознавания номеров, он дополняет rc и, наконец, RecordsView для расчёта проекционной матрицы, мы получаем наборы данных с необходимыми нам параметрами, что позволяет нам спокойно переходить к экспериментам.

\begin{figure}[!ht]
	\caption{Схема связки сервисов для генерации синтетического датасета.}\label{img:progs}
	\includegraphics[width=0.85\linewidth]{../png/programs.png}
	\centering
\end{figure}

\chapterconclusion
В данной части был описан процесс сбора реальных данных для исследования, также был определён объект наблюдений, то есть точка, на чьё перемещение мы будем смотреть. В качестве такого объекта был выбран номер, так как его координаты мы умеем распознавать с точностью до сантиметра. Также был подробно описан и обоснован процесс генерации синтетических данных для оценки качества алгоритма.

Кроме данных для оценки в данной главе был описан непосредственно алгоритм, по которому будет вычисляться скорость. В качестве основы решения была взята задача триангуляции, вторая камера компенсирована дополнительной информацией о номерном знаке.


\chapter{Результаты экспериментов}
После того, как скорость транспортного средства посчитана, необходимо провести оценку качества. Вспомним, что заявленная скорость прибора от 0 до 300 км/ч, это значит, что предложенное в данной работе решение должно корректно работать на всём диапазоне. В данной главе мы предложим способ оценки полученных результатов в соответствии с техническим заданием и заявленными характеристиками.

\section{Данные для анализа}
В секции \ref{sec:data} были собраны реальные записи, каждой из записей соответствует свой набор параметров, таких как количество полос, направление движения (встречное/попутное), высота установки, тип матрицы и т.д. Однако далеко не все параметры было возможно получить, поэтому недостающие данные были дополнены синтетическими.

Среди реальных данных максимальная радарная скорость составляла 52.5 км/ч, а минимальная --- 8.5 км/ч, поэтому диапазоны скоростей от 1 до 8 и от 53 до 299 были заполнены синтетическими данными. На этапе разработки именно радарная скорость будет использована для оценки качества.

\section{Матчинг радарных данных}\label{sec:radar}
Так как радар --- отдельная составляющая прибора, как, собственно, и камера, хоть и работают они в связке, всё равно независимо друг от друга, поэтому мы не можем с точностью сказать, какая радарная цель какому транспортному средству соответствует. Отсюда возникает задача матчинга радарных целей с распознанными номерами.

По триангулированным координатам номера мы можем получить положение этого номера в координатах дороги. Радарные цели также представлены в координатах дороги. Остаётся лишь определить ближайшие к радарным координатам координаты номера. Для этого пройдёмся по всем радарным целям, посчитаем декартово расстояние (формула \ref{eq:decart}) между коодинатами номера и радара и найдём ближайший ответ. В данном случае координату $ z $ номера можно опустить, так как нас интересует плоскость дороги. Матчинг происходит на этапе формирования структуры, описывающей трек каждого распознанного номера.

\section{Оценка погрешности} \label{sec:mistake}
В данной работе оценивать погрешность стандартными методами будет не совсем корректно, так как, во-первых, в техническом задании требуется получить погрешность \textit{по модулю}, не превышающую 2 км/ч, во-вторых, конечная цель исследования --- выписывать скоростные нарушения предложенным методом.

Из правил дорожного движения известно, что нарушение может быть выписано, при зафиксированной скорости более 19 км/ч от установленного на участке ограничения. Поэтому ложно положительными результатами будем считать результаты, где посчитанная скорость по модулю \textit{превышает} 19 км/ч. А погрешностью будем считать среднее по модулю расхождение радарной скорости с рассчитанной.

\section{Результаты}
В данной секции приведены результаты экспериментов отдельно для реальных и синтетических данных, рассчитана погрешность в соответствии с подсекцией \ref{sec:mistake} данной главы.

\subsection{Реальные данные}
Результаты экспериментов представлены в таблице \ref{tb:results}. Количество целей --- это количество транспортных средств на записи, чьи номера были распознаны; фреймов на цель --- количество фреймов, для которых оценивалась скорость; погрешность представляет из себя среднее по модулю расхождение радарной скорости с рассчитанной, переведённое в километры в час; и, наконец, часть выписанных ложных нарушений от всех рассчитанных скоростей.

Из результатов видно, что погрешность не превышает 2 км/ч, что соответствует ограничению, установленному в техническом задании. При этом среднее количество ложно выписанных нарушений составляет 1.5\%, что также является допустимым, хотя в дальнейшей работе ложные нарушения планируется исключить полностью.


\subsection{Синтетические данные}

Со сгенерированными данными результат получился намного точнее в силу "идеальности" данных. На рисунке \ref{img:ideal} представлен график зависимости рассчитанной на синтетических данных скорости от реальной и проведена аппроксимирующая прямая. Как несложно заметить, почти все точки лежат на ней.

\begin{figure}[!ht]
	\caption{График завизимости рассчитанной скорости от реальной.}\label{img:ideal}
	\includegraphics[width=0.85\linewidth]{../png/ideal_plot.png}
	\centering
\end{figure}

Средняя погрешность на синтетических данных составляет 0.1 км/ч, а ложно определённые нарушения отсутствуют. Их этих данных можно сделать вывод, что погрешность, вычисленная на реальных данных вызвана окружающими условия, а не качеством алгоритма.

%% Макрос для заключения. Совместим со старым стилевиком.
\chapterconclusion
В данной части был описан подход к анализу полученных данных и определены необходимые для этого данные. Был описан алгоритм матчинга радарных целей с рассчитанными скоростями. В качестве "эталона" для вычисленной скорости была взята ближайшая радарная цель.

В результате анализа полученных данных на реальном датасете, была получена средняя погрешность в 0.7 км/ч, при этом ложно зафиксированные нарушения составляют 1.5\%. Полученные результаты с запасом вписываются в техническое задание и соответствуют заявленным ограничениям.

\startconclusionpage
В данной работе были рассмотрены современные приборы фиксации нарушений правил дорожного движения и определены объект и цель работы. Как самый популярный прибор, для исследования был выбран "КОРДОН", вся текущая работа писалась под него и внедрена была также на этот прибор.

В качестве вспомогательных к работе материалов, были написаны скрипты для генерации синтетических данных в среде Blender, парсер для RC-формата прибора. В качестве сервисов совместной разработки выступили \texttt{gplay} и \texttt{RecordsView} --- сервис для генерации RC-файла из gltf-сцены и программа для просмотра RC-файлов соответственно.

За основу алгоритма определения скорости взята задача триангуляции с некоторыми изменениями, такими как компенсация отсутствия второй камеры уравнением, описывающим габариты номерного знака.

 После оценки результатов была получена погрешность 0.7 км/ч для реальных данных, что меньше 2 км/ч, заявленных в техническом задании, поэтому можно считать что задание выполнено. Кроме этого мы можем подтвердить корректность работы алгоритма на всём диапазоне скоростей, заявленных в характеристиках прибора. Также, можно вывести, что погрешность на реальных данных вызвана окружающими условиями, так как на сгенерированных данных она практически отсутствует.

\printmainbibliography

%% После этой команды chapter будет генерировать приложения, нумерованные русскими буквами.
%% \startappendices из старого стилевика будет делать то же самое
\appendix

\chapter{Описания форматов}\label{sec:app:1}

\begin{table}[!ht]
	\caption{Описание содержания RC-файла..}\label{tb1:rc-type}
	\centering
	\begin{tabular}{|p{0.2\textwidth}|p{0.15\textwidth}|p{0.15\textwidth}|p{0.4\textwidth}|}\hline
		\textbf{Имя} & \textbf{Тип}	&\textbf{Длина}&	\textbf{Описание} \\\hline\hline
		magic	& uint32\_t&	4 &	0x11223307\\\hline
		length	&uint32\_t	&4 &	Общая длина фрейма, включая поля magic и length\\\hline
		frame data&	- &	length - 8	 & -\\\hline
	\end{tabular}
\end{table}

\begin{table}[!ht]
	\caption{Описание содержания frame-а.}\label{tb1:frame-type}
	\centering
	\begin{tabular}{|p{0.2\textwidth}|p{0.15\textwidth}|p{0.15\textwidth}|p{0.4\textwidth}|}\hline
		\textbf{Имя} & \textbf{Тип}	&\textbf{Длина}&	\textbf{Описание} \\\hline\hline
		id	&uint16\_t&	2 & Тип описываемого поля\\\hline
		length&	uint32\_t	&4	&Длина данных\\\hline
		data&	-	&length	 &\\\hline

	\end{tabular}
\end{table}

\begin{center}
	%% |p{0.03\textwidth}|p{0.3\textwidth}|p{0.2\textwidth}|p{0.4\textwidth}|
	\begin{longtable}{|p{0.03\textwidth}|p{0.3\textwidth}|p{0.2\textwidth}|p{0.4\textwidth}|}
		\caption{Расшифровка поля ID из \texttt{frame data}.}\label{tb1:frame-data} \\ \hline
		\textbf{ID}	&\textbf{Данные}&\textbf{Тип/формат данных}&\textbf{Описание}\\\hline\hline
		0	&frame.capturingtime&	struct timeval	&Время съемки кадра\\\hline
		3	&frame.idx	&int32\_t&	ID кадра\\\hline
		4	&frame.frameticks	&uint32\_t&	Время съемки кадра в значении 90КГц счетчика\\\hline
		5	&Результаты распознавания ГРЗ	&массив TRectNumber'ов	&Распознанные с кадра номерные знаки, достоверности распознавания и координаты\\\hline
		8	&Цели с радара&	массив umrr\_target'ов&	Tracked цели с радара UMRR\\\hline
		14	&Ширина исходного изображения&	int32\_t	&Ширина исходного изображения\\\hline
		15	&Высота исходного изображения	&int32\_t&	Высота исходного изображения\\\hline
		19&	Ширина картинки	&int32\_t	&Ширина картинки\\\hline
		20	&Высота картинки	&int32\_t&	Высота картинки\\\hline
		21	&Размера изображение&	int32\_t	&Размер изображения в байтах (должен быть равен размеру поля 23)\\\hline
		22	&Формат картинки&	string	&JPEG, GRAYSCALE, YUV422P и т.д.\\\hline
		23&	Картинка&	данные&	непосредственно сама картинка\\\hline
		24	&GPS + данные о рейке&	MapString	&Данные о GPS (COGDEG=342.190002 DDLAT=59.92576700 DDLON=30.40147000 DDRADDR=559751168 HDOP=0.620000 SOGMPS=0.000000 SRC=ACTIVE SRC\_TIME=FPGA) и данные рейки (REIKADISTANCE=60 REIKALEN=1.79 REIKALENINPIXELS=74 REIKAPOINTS=0,0,0,0)\\\hline
		51&	Количество карт глубины	&uint32\_t	&Количество карт глубины на один фрейм (Nmaps)\\\hline
		51&	Матрица 3х4	&array<double, 12>	&Матрица 3х4\\\hline
		52	&Размер одной карты глубины	&uint32\_t	&Размер одной карты глубины в байтах (Dmap)\\\hline
		53&	Карты глубины	&uint16\_t [ ]&	Массив последовательно идущих данных карт глубины\\\hline
		54	&Преобразование	&uint16\_t [ ]&	Карта соотвтетсвия координат карты глубины коородинатам изображения фрейма\\\hline
		55&	Данные камеры&	struct sCameraData	&Данные о настройках камеры в момент формирования кадра\\\hline
		65&	frame.radar\_model&	enum class RadarModel: uint32\_t	&Модель радара\\\hline
	\end{longtable}
\end{center}

\chapter{Результаты}\label{sec:app:2}

\begin{center}
\begin{longtable}{|p{0.2\textwidth}|p{0.1\textwidth}|p{0.1\textwidth}|p{0.15\textwidth}|p{0.15\textwidth}|p{0.15\textwidth}|}
	\caption{Результаты экспериментов на реальных данных.}\label{tb:results}\\\hline
        \textbf{Имя файла} & \textbf{Количество целей} & \textbf{Фреймов на цель} & \textbf{Погрешность (м/с)} & \textbf{Погрешность (км/ч)} & \textbf{Процент ложных нарушений (false/all)}\\\hline\hline
        1580735812 2020.02.03 16-16-52 & 124 & 16 & 0.254809 & 0.92 & 0.007965\\\hline
        1597823270 2020.08.19 12-47-50 outgoint & 67 & 10 & 0.371781 & 1.34 & 0.001629\\\hline
        1593092046 2020.06.25 16-34-06 & 30 & 38 & 0.062644 & 0.23 & 0.007929\\\hline
        1649766196 2022.04.12 15-23-16 & 206 & 107 & 0.045629 & 0.16 & 0.019732\\\hline
        1581423064 2020.02.11 15-11-04 & 175 & 19 & 0.345780 & 1.24 & 0.042837\\\hline
        1597823299 2020.08.19 12-48-19 outgoint & 57 & 11 & 0.414410 & 1.49 & 0.004505\\\hline
        1648122446 2022.03.24 14-47-26 & 196 & 94 & 0.044238 & 0.16 & 0.015602\\\hline
        1580735555 2020.02.03 16-12-35 & 352 & 15 & 0.281440 & 1.01 & 0.014039\\\hline
        1596722130 2020.08.06 18-55-30 & 62 & 16 & 0.293159 & 1.06 & 0.004854\\\hline
        1649767179 2022.04.12 15-39-39 & 238 & 126 & 0.037682 & 0.14 & 0.009250\\\hline
        1644564468 2022.02.11 10-27-48 & 41 & 92 & 0.053859 & 0.19 & 0.012733\\\hline
        1597767405 2020.08.18 21-16-45 & 61 & 9 & 0.372369 & 1.34 & 0.002481\\\hline
        1645438993 2022.02.21 13-23-13 & 451 & 75 & 0.075862 & 0.27 & 0.030237\\\hline
        1644995982 2022.02.16 10-19-42 & 29 & 45 & 0.086472 & 0.31 & 0.008555\\\hline
        1581422841 2020.02.11 15-07-21 & 243 & 21 & 0.313150 & 1.13 & 0.039691\\\hline

\end{longtable}
\end{center}

\end{document}
